<!DOCTYPE HTML>
<html>
<head>
    <title>Leaflet with a layer of United States, using some d3</title>
    <meta charset="utf-8">
	<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.3/mapbox.css' rel='stylesheet' />
    <link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<style>
	path {
		stroke: #fff;
		stroke-width:1;
	}
</style>
<body>
	<h1>I am a leaflet map with <span>MapBox</span> bootstrapped, using 
		<span>d3.geo.transform</span>, 
		<span>d3.geo.path</span>, 
		<span>d3.scale.linear</span> and 
		<span>d3.mouse</span>.</h1>
	<div id="map" class="map"></div>
	<script src="../d3.v3.js"></script>
	<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.3/mapbox.js'></script>
	<script>
	var map = L.mapbox.map('map','jue.iddhipbe',{
		zoomAnimation:false
		}).setView([37.8471973,-97.8166684], 4);

	var svg = d3.select(map.getPanes().overlayPane).append("svg"),
		g = svg.append("g");

	d3.json('us-states.json',function(error, data){

		var transform = d3.geo.transform({
			point: function(x,y) {
				var point = map.latLngToLayerPoint(new L.LatLng(y,x));
				this.stream.point(point.x,point.y);
			}
		});
		var path = d3.geo.path().projection(transform);

		var popup = new L.Popup();

		// find out the color domain
		// map is native Array method
		var density = data.features.map(function(d){return d.properties.density});

		// create a color gradient
		var colors = d3.scale.linear()
			.domain([0,500])
			//.domain([d3.min(density),d3.max(density)]) // BUT WAIT SOMETHIN'S FISHY
			.range(['rgba(0,0,0,0.1)','rgba(0,0,0,0.9)']);

		var feature = g.selectAll("path")
			.data(data.features)
		  .enter()
		  	.append("path")
		  	.style("fill",function(d){return colors(d.properties.density);})

		map.on("viewreset", reset);
		reset();

		function reset() {
			var bounds = path.bounds(data),
				topLeft = bounds[0],
				bottomRight = bounds[1];
		
			svg.attr("width", bottomRight[0] - topLeft[0])
				.attr("height", bottomRight[1] - topLeft[1])
				.style("left", topLeft[0] + "px")
				.style("top", topLeft[1] + "px");
		
			g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
		
			feature.attr("d", path)
				.on("click",function(d){
					var position = d3.mouse(this);
					var popupContent = 'Population Density in ' + 
					d.properties.name + ': <b>' +
					d.properties.density + '</b> ' + 
					'people/mi<sup>2</sup>';

					//TODO
					popup.setLatLng(map.layerPointToLatLng(position))
						.setContent(popupContent)
						.openOn(map)
			});
		}
	})

	</script>
</body>